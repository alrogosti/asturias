<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaje a Asturias - Mapa Interactivo</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        .header {
            padding: 20px;
            background: linear-gradient(45deg, #2980b9, #3498db);
            color: white;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        /* Day selector */
        .day-selector {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .day-selector h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .day-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .day-btn {
            padding: 12px;
            border: 2px solid #bdc3c7;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9em;
            font-weight: 500;
        }

        .day-btn:hover {
            background: #ecf0f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .day-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        /* Time of day selector */
        .time-selector {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .time-selector h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .time-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .time-btn-container {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .time-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .time-btn.morning {
            background: #4682b4;
            color: white;
        }

        .time-btn.midday {
            background: #f1c40f;
            color: #2c3e50;
        }

        .time-btn.afternoon {
            background: #e67e22;
            color: white;
            position: relative;
        }

        .time-btn.night {
            background: #2c3e50;
            color: white;
        }

        .time-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .time-btn.active {
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transform: translateY(-3px);
        }

        /* Submenu para tarde */
        .sub-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 5px;
            margin: 0;
        }

        .sub-menu.expanded {
            max-height: 200px;
        }

        .sub-btn {
            display: block;
            width: calc(100% - 20px);
            padding: 10px 15px;
            margin: 5px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
            text-align: left;
            color: white;
            font-weight: 500;
        }

        .sub-btn.turismo {
            background: #EB9B53;
            color: white;
        }

        .sub-btn.surf {
            background: #F1B987;
            color: white;
        }

        .sub-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }

        .toggle-arrow.rotated {
            transform: rotate(90deg);
        }

        /* Legend */
        .legend {
            padding: 20px;
            flex-grow: 1;
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .legend-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            max-height: 300px;
            overflow-y: auto;
        }

        .legend-item {
            margin-bottom: 10px;
        }

        .legend-item strong {
            color: #2c3e50;
        }

        /* Map container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Custom popup styles */
        .custom-popup {
            font-family: Arial, sans-serif;
            text-align: center;
            max-width: 200px;
        }

        .popup-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .popup-description {
            margin-bottom: 10px;
            line-height: 1.4;
            color: #555;
        }

        .popup-link {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .popup-link:hover {
            background: #2980b9;
        }

        /* Show complete route button */
        .route-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .route-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        /* Loading indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .day-buttons {
                grid-template-columns: 1fr;
            }

            .route-btn {
                bottom: 10px;
                right: 10px;
                padding: 10px 16px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="header">
                <h1>üõ©Ô∏è Asturias con el piber√≠o</h1>
                <p>21-24 agosto 2025</p>
            </div>

            <div class="day-selector">
                <h3>üìÖ Selecciona el d√≠a</h3>
                <div class="day-buttons">
                    <button class="day-btn" data-day="jueves">Jueves 21</button>
                    <button class="day-btn active" data-day="viernes">Viernes 22</button>
                    <button class="day-btn" data-day="sabado">S√°bado 23</button>
                    <button class="day-btn" data-day="domingo">Domingo 24</button>
                </div>
            </div>

            <div class="time-selector">
                <h3>üïê Momento del d√≠a</h3>
                <div class="time-buttons">
                    <button class="time-btn morning" data-time="morning">
                        <span>üåÖ Ma√±ana</span>
                    </button>
                    <button class="time-btn midday" data-time="midday">
                        <span>‚òÄÔ∏è Mediod√≠a</span>
                    </button>
                    
                    <div class="time-btn-container">
                        <!-- Tarde para viernes 22 (con submenu) -->
                        <button class="time-btn afternoon" id="afternoonWithSubmenu" data-time="afternoon" style="display: none;">
                            <span>üåÜ Tarde</span>
                            <span class="toggle-arrow" id="afternoonArrow">‚ñ∂</span>
                        </button>
                        
                        <!-- Tarde para otros d√≠as (sin submenu) -->
                        <button class="time-btn afternoon" id="afternoonSimple" data-time="afternoon" style="display: flex;">
                            <span>üåÜ Tarde</span>
                        </button>
                        
                        <div class="sub-menu" id="afternoonSubmenu">
                            <button class="sub-btn turismo" data-time="afternoon_option1">
                                üåø Opci√≥n 1: Turismo
                            </button>
                            <button class="sub-btn surf" data-time="afternoon_option2">
                                üèÑ Opci√≥n 2: Surf
                            </button>
                        </div>
                    </div>
                    
                    <button class="time-btn night" data-time="night">
                        <span>üåô Noche</span>
                    </button>
                </div>
            </div>

            <div class="legend">
                <h3>üìã Detalles del plan</h3>
                <div class="legend-content">
                    <div id="legend-details">
                        <p>Selecciona un momento del d√≠a para ver los detalles del itinerario.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div class="loading" id="loadingDiv">
                <div class="spinner"></div>
                <div>Calculando ruta...</div>
            </div>
            
            <div id="map"></div>
            <button class="route-btn" id="showCompleteRoute">üó∫Ô∏è Ver ruta completa del d√≠a</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let currentMarkers = [];
        let currentRoutes = [];
        let currentTimeMarkers = [];
        let currentDay = 'viernes';
        let currentTime = null;
        let afternoonMenuExpanded = false;
        let routeCache = new Map();

        // Points of interest data
        const puntosInteres = [
            {
                nombre: "Apartamento Gij√≥n",
                lat: 43.540173,
                lng: -5.680419,
                descripcion: "C. de Mariano Pola, 49, Gij√≥n",
                tipo: "alojamiento",
                icono: "üè†"
            },
            {
                nombre: "Los Cauces - Arriondas",
                lat: 43.385733,
                lng: -5.176221,
                descripcion: "Inicio descenso del Sella en canoa",
                link: "https://maps.app.goo.gl/S6mA5bJRFugqZyZg6",
                tipo: "actividad",
                icono: "üö©"
            },
            {
                nombre: "Tora√±o",
                lat: 43.409546,
                lng: -5.112576,
                descripcion: "1¬™ parada descenso del Sella",
                tipo: "actividad",
                icono: "1Ô∏è‚É£"
                   },
                   {
                        nombre: "Fries",
                        lat: 43.424659,
                        lng: -5.083979,
                        descripcion: "2¬™ parada descenso del Sella",
                        tipo: "actividad",
                        icono: "2Ô∏è‚É£"
                   },
                   {
                        nombre: "Llovio",
                        lat: 43.438985,
                        lng: -5.055949,
                        descripcion: "3¬™ parada descenso del Sella",
                        tipo: "actividad",
                        icono: "3Ô∏è‚É£"
                   },
                   {
                        nombre: "Mes√≥n El Labrador",
                lat: 43.461315,
                lng: -5.060003,
                descripcion: "Restaurante en Ribadesella",
                link: "https://maps.app.goo.gl/EcTPqKAy7u6LFmos6",
                tipo: "restaurante",
                icono: "üçΩÔ∏è"
            },
            {
                nombre: "Bufones de Pr√≠a",
                lat: 43.458406,
                lng: -4.979759,
                descripcion: "Chimeneas naturales de agua",
                tipo: "naturaleza",
                icono: "üåä"
            },
            {
                nombre: "Playa de Gulpiyuri",
                lat: 43.447501,
                lng: -4.885987,
                descripcion: "Playa que aparece y desaparece con la marea",
                tipo: "playa",
                icono: "üèñÔ∏è"
            },
            {
                nombre: "Llanes",
                lat: 43.421162,
                lng: -4.756204,
                descripcion: "Pueblo para visitar y pasear",
                tipo: "pueblo",
                icono: "üèòÔ∏è"
            },
            {
                nombre: "Playa de Santa Marina",
                lat: 43.465991,
                lng: -5.071141,
                descripcion: "Surf con marea baja/media - Ribadesella",
                tipo: "surf",
                icono: "üèÑ"
            },
            {
                nombre: "Playa de San Antol√≠n",
                lat: 43.442742,
                lng: -4.867269,
                descripcion: "Playa larga para surf - Llanes",
                tipo: "surf",
                icono: "üèÑ"
            },
            {
                nombre: "Caser√≠a de Santa Marina",
                lat: 43.401243,
                lng: -4.781588,
                descripcion: "Cachopada de kilo",
                link: "https://maps.app.goo.gl/3bzBzkMPRqsc5Ytz8",
                tipo: "restaurante",
                icono: "üçΩÔ∏è"
            },
            {
                nombre: "Ribadesella",
                lat: 43.4621,
                lng: -5.0589,
                descripcion: "Pueblo costero",
                tipo: "pueblo",
                icono: "üèòÔ∏è"
            }
        ];

        // Itinerary data
        const itinerario = {
            viernes: {
                morning: {
                    puntos: ["Apartamento Gij√≥n", "Los Cauces - Arriondas"],
                    puntosRiver: ["Los Cauces - Arriondas", "Tora√±o", "Fries", "Llovio"],
                    detalles: "üöó 9:00-10:00 ‚Üí Traslado en coche a Arriondas.<br>üö£ 10:30 ‚Üí Inicio descenso del Sella.<br>üìçEscoger parada:<br>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp‚Ä¢ Tora√±o (7km - 2,5h)<br>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp‚Ä¢ Fries (14km - 3,5h)<br>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp‚Ä¢ Llovio (17km - 4,5h)<br>üí∞ 30‚Ç¨ por persona (independiente parada).<br>üöê 14:00-15:00 ‚Üí Fin del recorrido, regreso en furgoneta a Arriondas.",
                    color: "#4682b4"
                },
                midday: {
                    puntos: ["Los Cauces - Arriondas", "Mes√≥n El Labrador"],
                    detalles: "üçΩÔ∏è Comida en Mes√≥n El Labrador.<br>üç≤ Especialidad: Men√∫ completo y variado.<br>üìû Reserva confirmada a las 15:30h.<br>üí∞ 20-30‚Ç¨ por persona.",
                    color: "#f1c40f"
                },
                afternoon_option1: {
                    puntos: ["Ribadesella", "Bufones de Pr√≠a", "Playa de Gulpiyuri", "Llanes"],
                    detalles: "üéØ Opci√≥n 1: Ruta costera y turismo natural.<br>&nbsp&nbsp&nbsp‚Ä¢ üåä Bufones de Pr√≠a.<br>&nbsp&nbsp&nbsp‚Ä¢ üèñÔ∏è Playa de Gulpiyuri.<br>&nbsp&nbsp&nbsp‚Ä¢ üèòÔ∏è Llanes.<br>‚è∞ Duraci√≥n estimada: 4 horas.",
                    color: "#EB9B53"
                },
                afternoon_option2: {
                    puntos: ["Ribadesella", "Playa de Santa Marina"],
                    puntos2: ["Playa de Santa Marina", "Playa de San Antol√≠n"],
                    detalles: "üèÑ Opci√≥n 2: Surf entre Ribadesella y Llanes.<br>&nbsp&nbsp&nbsp‚Ä¢ üèñÔ∏è Playa de Santa Marina.<br>&nbsp&nbsp&nbsp‚Ä¢ üèñÔ∏è Playa de San Antol√≠n.<br>‚è∞ Duraci√≥n estimada: 2 horas.",
                    color: "#F1B987"
                },
                night: {
                    puntos: ["Llanes", "Caser√≠a de Santa Marina"],
                    puntosAlt: ["Playa de San Antol√≠n", "Caser√≠a de Santa Marina"],
                    puntosReturn: ["Caser√≠a de Santa Marina", "Apartamento Gij√≥n"],
                    detalles: "üçΩÔ∏è Cena en Caser√≠a de Santa Marina.<br>ü•© Especialidad: Cachopo.<br>üìû Reserva confirmada a las 21:30h.<br>üí∞ 30‚Ç¨-40‚Ç¨ por persona.<br>üöó Regreso al apartamento: ~23:30.",
                    color: "#2c3e50"
                }
            },
            jueves: {
                morning: { puntos: [], detalles: "Llegada y acomodaci√≥n - Plan libre", color: "#4682b4" },
                midday: { puntos: [], detalles: "Exploraci√≥n de Gij√≥n - Plan libre", color: "#f1c40f" },
                afternoon: { puntos: [], detalles: "Descanso y preparativos - Plan libre", color: "#e67e22" },
                night: { puntos: [], detalles: "Cena local en Gij√≥n - Plan libre", color: "#2c3e50" }
            },
            sabado: {
                morning: { puntos: [], detalles: "Por planificar...", color: "#4682b4" },
                midday: { puntos: [], detalles: "Por planificar...", color: "#f1c40f" },
                afternoon: { puntos: [], detalles: "Por planificar...", color: "#e67e22" },
                night: { puntos: [], detalles: "Por planificar...", color: "#2c3e50" }
            },
            domingo: {
                morning: { puntos: [], detalles: "√öltima ma√±ana - Check out", color: "#4682b4" },
                midday: { puntos: [], detalles: "Regreso - Viaje de vuelta", color: "#f1c40f" },
                afternoon: { puntos: [], detalles: "Viaje de vuelta", color: "#e67e22" },
                night: { puntos: [], detalles: "Llegada a casa", color: "#2c3e50" }
            }
        };

        // Utility functions
        function showLoading(show = true) {
            const loadingDiv = document.getElementById('loadingDiv');
            loadingDiv.style.display = show ? 'block' : 'none';
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        function formatDuration(minutes) {
            if (minutes < 60) {
                return `${minutes} min`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}min` : `${hours}h`;
            }
        }

        // Route calculation
        async function calculateCarRoute(start, end) {
            const cacheKey = `${start.lat},${start.lng}_${end.lat},${end.lng}`;
            
            if (routeCache.has(cacheKey)) {
                return routeCache.get(cacheKey);
            }

            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coordinates = route.geometry.coordinates;
                    const leafletRoute = coordinates.map(coord => [coord[1], coord[0]]);
                    
                    const duration = Math.round(route.duration / 60);
                    const distance = (route.distance / 1000).toFixed(1);
                    
                    const result = {
                        route: leafletRoute,
                        duration: duration,
                        distance: distance,
                        durationText: formatDuration(duration),
                        service: 'OSRM'
                    };
                    
                    routeCache.set(cacheKey, result);
                    return result;
                } else {
                    throw new Error('No route found');
                }
            } catch (error) {
                console.warn('OSRM failed, using fallback:', error.message);
                const distance = getDistanceFromLatLonInKm(start.lat, start.lng, end.lat, end.lng);
                const duration = Math.round(distance * 1.8);
                
                const result = {
                    route: [[start.lat, start.lng], [end.lat, end.lng]],
                    duration: duration,
                    distance: distance.toFixed(1),
                    durationText: formatDuration(duration),
                    isFallback: true,
                    service: 'Fallback'
                };
                
                routeCache.set(cacheKey, result);
                return result;
            }
        }

        function getRiverTime(from, to) {
            const riverTimes = {
                "Los Cauces - Arriondas_Tora√±o": "2h 30min",
                "Tora√±o_Fries": "1h 15min", 
                "Fries_Llovio": "45min"
            };
            return riverTimes[`${from}_${to}`] || "1h";
        }

        function getRiverDistance(from, to) {
            const riverDistances = {
                "Los Cauces - Arriondas_Tora√±o": "7 km",
                "Tora√±o_Fries": "3.5 km",
                "Fries_Llovio": "2.5 km"
            };
            return riverDistances[`${from}_${to}`] || "5 km";
        }

        // Icon and marker creation
        function createCustomIcon(punto, color = '#3498db') {
            return L.divIcon({
                html: `<div style="background: ${color}; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 16px;">${punto.icono}</div>`,
                className: 'custom-marker',
                iconSize: [35, 35]
            });
        }

        function createTimeMarker(midLat, midLng, routeInfo, color, isRiver = false) {
            const icon = isRiver ? "üõ∂" : "üöó";
            const timeText = routeInfo.durationText || routeInfo.duration;
            const distanceText = routeInfo.distanceText || `${routeInfo.distance} km`;
            
            const html = `
                <div style="
                    background: ${color};
                    padding: 8px 12px;
                    border-radius: 15px;
                    font-weight: bold;
                    display: inline-block;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    text-align: center;
                    color: white;
                    font-size: 0.8em;
                ">
                    <span style="font-size: 1.8em;">${icon}</span><br>
                    <div style="margin: 2px 0;">${timeText}</div>
                    <small>${distanceText}</small>
                </div>
            `;
            
            return L.marker([midLat, midLng], {
                icon: L.divIcon({
                    html: html,
                    iconSize: [80, 60],
                    iconAnchor: [40, 30],
                    className: 'time-marker'
                })
            });
        }

        // Route creation
        async function createRoutesBetweenPoints(puntos, color, isRiver = false, isNight = false) {
            const allRoutes = [];
            const timeMarkers = [];
            
            for (let i = 0; i < puntos.length - 1; i++) {
                const startPoint = puntosInteres.find(p => p.nombre === puntos[i]);
                const endPoint = puntosInteres.find(p => p.nombre === puntos[i + 1]);
                
                if (!startPoint || !endPoint) continue;
                
                let routeInfo;
                
                if (isRiver) {
                    routeInfo = {
                        route: [[startPoint.lat, startPoint.lng], [endPoint.lat, endPoint.lng]],
                        durationText: getRiverTime(puntos[i], puntos[i + 1]),
                        distanceText: getRiverDistance(puntos[i], puntos[i + 1]),
                        isRiver: true
                    };
                } else {
                    routeInfo = await calculateCarRoute(startPoint, endPoint);
                }
                
                const lineStyle = {
                    color: color,
                    weight: 5,
                    opacity: 0.8,
                    smoothFactor: 1
                };
                
                if (isRiver) {
                    lineStyle.dashArray = '10, 5';
                } else if (isNight) {
                    lineStyle.dashArray = '15, 10';
                }
                
                const polyline = L.polyline(routeInfo.route, lineStyle).addTo(map);
                allRoutes.push(polyline);
                
                const midLat = (startPoint.lat + endPoint.lat) / 2;
                const midLng = (startPoint.lng + endPoint.lng) / 2;
                
                const timeMarker = createTimeMarker(midLat, midLng, routeInfo, color, isRiver);
                timeMarker.addTo(map);
                timeMarkers.push(timeMarker);
            }
            
            return { routes: allRoutes, markers: timeMarkers };
        }

        function showPointsMarkers(pointNames, color) {
            pointNames.forEach(nombrePunto => {
                const punto = puntosInteres.find(p => p.nombre === nombrePunto);
                if (punto && punto.tipo !== 'alojamiento') {
                    const marker = L.marker([punto.lat, punto.lng], {
                        icon: createCustomIcon(punto, color)
                    }).addTo(map);

                    let popupContent = `
                        <div class="custom-popup">
                            <div class="popup-header">${punto.nombre}</div>
                            <div class="popup-description">${punto.descripcion}</div>
                    `;
                    
                    if (punto.link) {
                        popupContent += `<a href="${punto.link}" target="_blank" class="popup-link">üìç Ver en Maps</a>`;
                    }
                    
                    popupContent += '</div>';
                    
                    marker.bindPopup(popupContent);
                    currentMarkers.push(marker);
                }
            });
        }

        async function showPointsForTime(day, time) {
            clearAll();
            showLoading(true);
            
            try {
                if (!itinerario[day] || !itinerario[day][time]) return;

                const timeData = itinerario[day][time];
                
                if (timeData.puntos.length === 0) {
                    document.getElementById('legend-details').innerHTML = timeData.detalles;
                    return;
                }

                let allRoutes = [];
                
                // Main points
                showPointsMarkers(timeData.puntos, timeData.color);
                const { routes: routes1, markers: markers1 } = await createRoutesBetweenPoints(
                    timeData.puntos, 
                    timeData.color, 
                    false, 
                    time === 'night'
                );
                allRoutes.push(...routes1);
                currentRoutes.push(...routes1);
                currentTimeMarkers.push(...markers1);
                
                // River points (for morning - Sella descent)
                if (timeData.puntosRiver) {
                    showPointsMarkers(timeData.puntosRiver, timeData.color);
                    const { routes: routes2, markers: markers2 } = await createRoutesBetweenPoints(
                        timeData.puntosRiver, 
                        timeData.color, 
                        true, 
                        false
                    );
                    allRoutes.push(...routes2);
                    currentRoutes.push(...routes2);
                    currentTimeMarkers.push(...markers2);
                }
                
                // Additional points (for surf option)
                if (timeData.puntos2) {
                    showPointsMarkers(timeData.puntos2, timeData.color);
                    const { routes: routes3, markers: markers3 } = await createRoutesBetweenPoints(
                        timeData.puntos2, 
                        timeData.color, 
                        false, 
                        false
                    );
                    allRoutes.push(...routes3);
                    currentRoutes.push(...routes3);
                    currentTimeMarkers.push(...markers3);
                }
                
                // Alternative points (for night from surf option)
                if (timeData.puntosAlt) {
                    showPointsMarkers(timeData.puntosAlt, timeData.color);
                    const { routes: routes3, markers: markers3 } = await createRoutesBetweenPoints(
                        timeData.puntosAlt, 
                        timeData.color, 
                        false, 
                        true
                    );
                    allRoutes.push(...routes3);
                    currentRoutes.push(...routes3);
                    currentTimeMarkers.push(...markers3);
                }
                
                // Return home points (for night)
                if (timeData.puntosReturn) {
                    showPointsMarkers(timeData.puntosReturn, timeData.color);
                    const { routes: routes4, markers: markers4 } = await createRoutesBetweenPoints(
                        timeData.puntosReturn, 
                        timeData.color, 
                        false, 
                        false
                    );
                    allRoutes.push(...routes4);
                    currentRoutes.push(...routes4);
                    currentTimeMarkers.push(...markers4);
                }

                // Fit bounds
                if (allRoutes.length > 0) {
                    const allPoints = [];
                    allRoutes.forEach(route => allPoints.push(...route.getLatLngs()));
                    if (allPoints.length > 0) {
                        const bounds = L.latLngBounds(allPoints);
                        map.fitBounds(bounds, { padding: [20, 20] });
                    }
                }

                document.getElementById('legend-details').innerHTML = timeData.detalles;
                
            } catch (error) {
                console.error('Error showing points for time:', error);
                alert('Error al mostrar la ruta. Int√©ntalo de nuevo.');
            } finally {
                showLoading(false);
            }
        }

        async function showCompleteRoute(day) {
            clearAll();
            showLoading(true);
            
            try {
                const dayData = itinerario[day];
                if (!dayData) return;

                const allPoints = [];
                let detailsHtml = `<strong>üó∫Ô∏è Ruta completa del ${day === 'viernes' ? 'Viernes 22' : day}</strong><br><br>`;

                const timeSlots = ['morning', 'midday', 'afternoon_option1', 'afternoon_option2', 'night'];
                
                for (const timeSlot of timeSlots) {
                    const timeData = dayData[timeSlot];
                    if (timeData && timeData.puntos.length > 0) {
                        // Show markers
                        showPointsMarkers(timeData.puntos, timeData.color);
                        
                        // Create routes for main points
                        const { routes: routes1, markers: markers1 } = await createRoutesBetweenPoints(
                            timeData.puntos, 
                            timeData.color, 
                            false, 
                            timeSlot === 'night'
                        );
                        currentRoutes.push(...routes1);
                        currentTimeMarkers.push(...markers1);
                        routes1.forEach(route => allPoints.push(...route.getLatLngs()));
                        
                        // Handle special point arrays
                        if (timeData.puntosRiver) {
                            showPointsMarkers(timeData.puntosRiver, timeData.color);
                            const { routes: routes2, markers: markers2 } = await createRoutesBetweenPoints(
                                timeData.puntosRiver, 
                                timeData.color, 
                                true, 
                                false
                            );
                            currentRoutes.push(...routes2);
                            currentTimeMarkers.push(...markers2);
                            routes2.forEach(route => allPoints.push(...route.getLatLngs()));
                        }
                        
                        if (timeData.puntos2) {
                            showPointsMarkers(timeData.puntos2, timeData.color);
                            const { routes: routes3, markers: markers3 } = await createRoutesBetweenPoints(
                                timeData.puntos2, 
                                timeData.color, 
                                false, 
                                false
                            );
                            currentRoutes.push(...routes3);
                            currentTimeMarkers.push(...markers3);
                            routes3.forEach(route => allPoints.push(...route.getLatLngs()));
                        }
                        
                        if (timeData.puntosAlt) {
                            showPointsMarkers(timeData.puntosAlt, timeData.color);
                            const { routes: routes3, markers: markers3 } = await createRoutesBetweenPoints(
                                timeData.puntosAlt, 
                                timeData.color, 
                                false, 
                                true
                            );
                            currentRoutes.push(...routes3);
                            currentTimeMarkers.push(...markers3);
                            routes3.forEach(route => allPoints.push(...route.getLatLngs()));
                        }
                        
                        if (timeData.puntosReturn) {
                            showPointsMarkers(timeData.puntosReturn, timeData.color);
                            const { routes: routes4, markers: markers4 } = await createRoutesBetweenPoints(
                                timeData.puntosReturn, 
                                timeData.color, 
                                false, 
                                false
                            );
                            currentRoutes.push(...routes4);
                            currentTimeMarkers.push(...markers4);
                            routes4.forEach(route => allPoints.push(...route.getLatLngs()));
                        }
                    }
                }

                // Fit bounds
                if (allPoints.length > 0) {
                    const bounds = L.latLngBounds(allPoints);
                    map.fitBounds(bounds, { padding: [20, 20] });
                }

                detailsHtml += `
                    Se muestran todos los puntos del d√≠a:<br>
                    üåÖ <span style="color: #87ceeb;">Ma√±ana</span> | 
                    ‚òÄÔ∏è <span style="color: #f1c40f;">Mediod√≠a</span><br>
                    üåÜ <span style="color: #e67e22;">Tarde</span> |
                    üåô <span style="color: #2c3e50;">Noche</span>
                `;
                
                document.getElementById('legend-details').innerHTML = detailsHtml;
                
            } catch (error) {
                console.error('Error showing complete route:', error);
                alert('Error al mostrar la ruta completa. Int√©ntalo de nuevo.');
            } finally {
                showLoading(false);
            }
        }

        function clearAll() {
            // Clear markers
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];
            
            // Clear routes
            currentRoutes.forEach(route => map.removeLayer(route));
            currentRoutes = [];
            
            // Clear time markers
            currentTimeMarkers.forEach(marker => map.removeLayer(marker));
            currentTimeMarkers = [];
        }

        function toggleAfternoonMenu() {
            const submenu = document.getElementById('afternoonSubmenu');
            const arrow = document.getElementById('afternoonArrow');
            
            afternoonMenuExpanded = !afternoonMenuExpanded;
            
            if (afternoonMenuExpanded) {
                submenu.classList.add('expanded');
                arrow.classList.add('rotated');
                arrow.textContent = '‚ñ∂';
            } else {
                submenu.classList.remove('expanded');
                arrow.classList.remove('rotated');
                arrow.textContent = '‚ñ∂';
                
                // Clear active states from sub-buttons
                document.querySelectorAll('.sub-btn').forEach(btn => btn.classList.remove('active'));
            }
        }

        function updateAfternoonButtonVisibility() {
            const afternoonWithSubmenu = document.getElementById('afternoonWithSubmenu');
            const afternoonSimple = document.getElementById('afternoonSimple');
            const afternoonSubmenu = document.getElementById('afternoonSubmenu');
            
            if (currentDay === 'viernes') {
                afternoonWithSubmenu.style.display = 'flex';
                afternoonSimple.style.display = 'none';
            } else {
                afternoonWithSubmenu.style.display = 'none';
                afternoonSimple.style.display = 'flex';
                afternoonSubmenu.classList.remove('expanded');
                afternoonMenuExpanded = false;
                const arrow = document.getElementById('afternoonArrow');
                if (arrow) {
                    arrow.classList.remove('rotated');
                    arrow.textContent = '‚ñ∂';
                }
            }
        }

        // Initialize map and events
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            map = L.map('map').setView([43.4621, -5.0589], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Always show accommodation marker
            const accommodation = puntosInteres.find(p => p.tipo === 'alojamiento');
            const accommodationMarker = L.marker([accommodation.lat, accommodation.lng], {
                icon: L.divIcon({
                    html: `<div style="background: #e74c3c; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 18px; color: white;">${accommodation.icono}</div>`,
                    className: 'custom-marker',
                    iconSize: [40, 40]
                })
            }).addTo(map);

            accommodationMarker.bindPopup(`
                <div class="custom-popup">
                    <div class="popup-header">${accommodation.nombre}</div>
                    <div class="popup-description">${accommodation.descripcion}</div>
                </div>
            `);

            // Day buttons event listeners
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentDay = e.target.dataset.day;
                    
                    // Actualizar visibilidad del bot√≥n de tarde
                    updateAfternoonButtonVisibility();
                    
                    // Reset time selection
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
                    currentTime = null;
                    
                    // Close afternoon submenu
                    if (afternoonMenuExpanded) {
                        toggleAfternoonMenu();
                    }
                    
                    // Clear map
                    clearAll();
                    
                    document.getElementById('legend-details').innerHTML = 'Selecciona un momento del d√≠a para ver los detalles del itinerario.';
                });
            });

            // Time buttons event listeners
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const timeValue = e.target.dataset.time;
                    
                    if (timeValue === 'afternoon') {
                        // Solo mostrar submenu para viernes
                        if (currentDay === 'viernes') {
                            toggleAfternoonMenu();
                        } else {
                            // Para otros d√≠as, mostrar tarde normal
                            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                            document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            currentTime = 'afternoon';
                            showPointsForTime(currentDay, currentTime);
                        }
                        return;
                    }
                    
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentTime = timeValue;
                    showPointsForTime(currentDay, currentTime);
                });
            });

            // Sub-buttons event listeners (afternoon options)
            document.querySelectorAll('.sub-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentTime = e.target.dataset.time;
                    showPointsForTime(currentDay, currentTime);
                });
            });

            // Complete route button
            document.getElementById('showCompleteRoute').addEventListener('click', () => {
                showCompleteRoute(currentDay);
            });

            // Set initial legend text
            document.getElementById('legend-details').innerHTML = 'Selecciona un momento del d√≠a para ver los detalles del itinerario.';
            
            // Initialize afternoon button visibility
            updateAfternoonButtonVisibility();
        });
    </script>
</body>
</html>